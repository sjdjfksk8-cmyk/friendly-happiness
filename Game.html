<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>–°–∞–Ω—è –≤ —à–∫–æ–ª—É, –±–ª—è ‚Äî 2D v3</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: Arial, sans-serif; color: white; touch-action: none; }
    #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; z-index: 30; text-shadow: 0 0 10px red; pointer-events: none; }
    #ui { position: absolute; top: 10px; left: 10px; font-size: 18px; pointer-events: none; z-index: 10; text-shadow: 1px 1px 3px black; }
    #message { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: lime; font-size: 28px; background: rgba(0,0,0,0.8); padding: 25px; border-radius: 12px; display: none; pointer-events: none; z-index: 20; text-align: center; max-width: 90%; }
    #unmute-all-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; background: #c00; color: white; border: none; font-size: 24px; cursor: pointer; z-index: 25; display: none; border-radius: 12px; }
    #virtual-e { position: absolute; bottom: 30px; right: 30px; width: 80px; height: 80px; background: rgba(255,255,255,0.3); color: white; font-size: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 15; pointer-events: all; }
  </style>
</head>
<body>
  <div id="loader">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, —Å—É–∫–∞... üòà</div>
  <div id="ui">WASD / —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî —Ö–æ–¥–∏, E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å<br>–ù–∞ –º–æ–±–∏–ª–∫–µ: —Å–≤–∞–π–ø–∞–π + –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ E</div>
  <div id="message"></div>
  <button id="unmute-all-btn">–í–ö–õ –ó–í–£–ö (—Ç–∞–ø–Ω–∏ —Å—é–¥–∞)</button>
  <div id="virtual-e">E</div>

  <canvas id="canvas"></canvas>

  <script>
    // Loader
    setTimeout(() => document.getElementById('loader').style.display = 'none', 2500);

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // –ò–≥—Ä–æ–∫
    const player = { x: canvas.width / 2, y: canvas.height / 2 + 100, size: 40, speed: 5, color: '#00aaff' };

    let currentScene = 'room';
    let interacted = false; // —Ñ–ª–∞–≥, —á—Ç–æ —é–∑–µ—Ä —Ç–∞–ø–Ω—É–ª

    // –û–±—ä–µ–∫—Ç—ã
    const objects = {
      room: [{ type: 'door', x: canvas.width - 120, y: canvas.height / 2 - 80, w: 80, h: 160, color: '#8B4513', action: () => { currentScene = 'corridor'; player.x = 150; player.y = canvas.height / 2; showMessage('–¢—ã –≤—ã—à–µ–ª –≤ –∫–æ—Ä–∏–¥–æ—Ä...'); } }],
      corridor: [
        { type: 'door_back', x: 40, y: canvas.height / 2 - 80, w: 80, h: 160, color: '#8B4513', action: () => { currentScene = 'room'; player.x = canvas.width - 200; player.y = canvas.height / 2; showMessage('–í–µ—Ä–Ω—É–ª—Å—è –≤ –∫–æ–º–Ω–∞—Ç—É'); } },
        { type: 'door_mom', x: canvas.width - 120, y: canvas.height / 2 - 80, w: 80, h: 160, color: '#8B4513', action: () => showMessage('–î–≤–µ—Ä—å –º–∞–º—ã –∑–∞–∫—Ä—ã—Ç–∞<br>–ú–∞–º–∫–∞ —Å–ø–∏—Ç, –Ω–µ –±—É–¥–∏ —Å—É–∫–∞ üò¥') },
        { type: 'tv', x: canvas.width / 2 - 200, y: 20, w: 400, h: 220, color: '#111', action: () => showMessage('–ù–∞ –¢–í –æ—Ä—ë—Ç "–≠–∫–∏–ø–∞–∂ —Ç–µ–±–µ –≤ —à–∫–æ–ª—É"') }
      ]
    };

    let tvIframe = null;
    function createTV() {
      if (tvIframe) tvIframe.remove();
      tvIframe = document.createElement('iframe');
      tvIframe.style.position = 'absolute';
      tvIframe.style.top = '20px';
      tvIframe.style.left = '50%';
      tvIframe.style.transform = 'translateX(-50%)';
      tvIframe.style.width = '400px';
      tvIframe.style.height = '220px';
      tvIframe.style.border = 'none';
      tvIframe.style.zIndex = '5';
      tvIframe.style.pointerEvents = 'all';
      tvIframe.src = 'https://www.youtube-nocookie.com/embed/-D-YcXanLcM?autoplay=1&mute=1&loop=1&playlist=-D-YcXanLcM&controls=1&modestbranding=1&rel=0';
      tvIframe.setAttribute('allow', 'autoplay; encrypted-media');
      tvIframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
      tvIframe.allowFullscreen = true;
      document.body.appendChild(tvIframe);
    }

    function showMessage(text, duration = 6000) {
      const msg = document.getElementById('message');
      msg.innerHTML = text;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', duration);
    }

    // –ö–ª–∞–≤–∏—à–∏ + touch
    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    let touchStartX = 0, touchStartY = 0;
    canvas.addEventListener('touchstart', e => {
      if (e.touches.length) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        interacted = true; // –ª—é–±–æ–π —Ç–∞–ø ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
        checkUnmute();
      }
    });
    canvas.addEventListener('touchmove', e => {
      if (e.touches.length) {
        const dx = e.touches[0].clientX - touchStartX;
        const dy = e.touches[0].clientY - touchStartY;
        player.x += dx * 0.15;
        player.y += dy * 0.15;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
    });

    // –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è E
    document.getElementById('virtual-e').addEventListener('touchstart', () => {
      keys['KeyE'] = true;
      interacted = true;
      checkUnmute();
    });
    document.getElementById('virtual-e').addEventListener('touchend', () => keys['KeyE'] = false);

    // –ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ unmute
    const unmuteBtn = document.getElementById('unmute-all-btn');
    unmuteBtn.addEventListener('click', () => {
      interacted = true;
      if (tvIframe) tvIframe.src = tvIframe.src.replace('&mute=1', '');
      unmuteBtn.style.display = 'none';
      showMessage('–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω! (–µ—Å–ª–∏ –Ω–µ —Å–ª—ã—à–Ω–æ ‚Äî —Ç–∞–ø–Ω–∏ –µ—â—ë —Ä–∞–∑ –ø–æ —ç–∫—Ä–∞–Ω—É)');
    });

    function checkUnmute() {
      if (interacted && tvIframe && tvIframe.src.includes('&mute=1')) {
        tvIframe.src = tvIframe.src.replace('&mute=1', '');
        unmuteBtn.style.display = 'none';
      }
    }

    // –¶–∏–∫–ª
    function gameLoop() {
      ctx.fillStyle = currentScene === 'room' ? '#222244' : '#333355';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#334455';
      ctx.fillRect(0, 0, canvas.width, 60);
      ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
      ctx.fillRect(0, 0, 60, canvas.height);
      ctx.fillRect(canvas.width - 60, 0, 60, canvas.height);

      objects[currentScene].forEach(obj => {
        ctx.fillStyle = obj.color;
        ctx.fillRect(obj.x, obj.y, obj.w || 80, obj.h || 80);
      });

      ctx.fillStyle = player.color;
      ctx.fillRect(player.x - player.size/2, player.y - player.size/2, player.size, player.size);

      if (keys['KeyW'] || keys['ArrowUp']) player.y -= player.speed;
      if (keys['KeyS'] || keys['ArrowDown']) player.y += player.speed;
      if (keys['KeyA'] || keys['ArrowLeft']) player.x -= player.speed;
      if (keys['KeyD'] || keys['ArrowRight']) player.x += player.speed;

      player.x = Math.max(60 + player.size/2, Math.min(canvas.width - 60 - player.size/2, player.x));
      player.y = Math.max(60 + player.size/2, Math.min(canvas.height - 60 - player.size/2, player.y));

      if (keys['KeyE']) {
        keys['KeyE'] = false;
        interacted = true;
        checkUnmute();
        objects[currentScene].forEach(obj => {
          if (Math.hypot(player.x - (obj.x + (obj.w||80)/2), player.y - (obj.y + (obj.h||80)/2)) < 100) {
            if (obj.action) obj.action();
          }
        });
      }

      requestAnimationFrame(gameLoop);
    }

    // –¢–í
    setInterval(() => {
      if (currentScene === 'corridor' && !tvIframe) createTV();
      else if (currentScene !== 'corridor' && tvIframe) { tvIframe.remove(); tvIframe = null; }
    }, 500);

    // –ò—Å—Ç–æ—Ä–∏—è
    setTimeout(() => {
      alert("–°–∞–Ω—è: –ë–ª—è, –Ω–∞–¥–æ –≤ —à–∫–æ–ª—É... –ê —Ö–æ—Ç—è –ª–∞–¥–Ω–æ –ø–æ—Ö—É–π");

      setTimeout(() => {
        alert("–ú–∞–º–∫–∞: –ê –ù–£ –í–°–¢–ê–í–ê–ô –ü–ò–ó–î–Æ–ö!");

        const mom = document.createElement('iframe');
        mom.style.display = 'none';
        mom.src = 'https://www.youtube-nocookie.com/embed/6RAzJHW1bqc?autoplay=1&mute=1&start=0&end=9&referrerpolicy=strict-origin-when-cross-origin';
        document.body.appendChild(mom);

        setTimeout(() => {
          mom.remove();
          alert("–°–∞–Ω—è: –î–∞ –Ω–∞—Ö—É–π –æ–Ω–∞ –≤–æ–æ–±—â–µ –Ω—É–∂–Ω–∞...");
        }, 9000);

        setTimeout(() => alert("–ú–∞–º–∫–∞ —É—Ö–æ–¥–∏—Ç..."), 12000);
        setTimeout(() => {
          alert("–°–∞–Ω—è: –°—É–∫–∞...");
          unmuteBtn.style.display = 'block'; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É
        }, 14000);
      }, 3000);
    }, 4000);

    gameLoop();
  </script>
</body>
</html>
