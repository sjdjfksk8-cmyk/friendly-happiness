<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VR Hands Tracking –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
    #start { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px 60px; background: #c00; color: white; border: none; font-size: 32px; cursor: pointer; z-index: 30; border-radius: 20px; box-shadow: 0 0 20px red; text-align: center; }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #0f0; font-size: 50px; background: rgba(0,0,0,0.7); padding: 40px; border-radius: 20px; display: none; pointer-events: none; z-index: 20; text-align: center; max-width: 90%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>
  <button id="start">–¢–ê–ü–ù–ò ‚Üí –ö–ê–ú–ï–†–ê + –†–£–ö–ò</button>
  <video id="video" autoplay playsinline style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"></video>
  <canvas id="overlay"></canvas>
  <div id="msg">–ë—Ä–∞—Ç–∏—à–∫–∞ –ø–ª–∞—á–µ—Ç –∑–∞ –¥–≤–µ—Ä—å—é... üò¢</div>

  <audio id="sad" src="https://www.myinstants.com/media/sounds/sadkid.mp3"></audio>

  <script>
    const startBtn = document.getElementById('start');
    const msg = document.getElementById('msg');
    const sad = document.getElementById('sad');
    let pinchActive = false;

    startBtn.addEventListener('click', async () => {
      startBtn.style.display = 'none';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        document.getElementById('video').srcObject = stream;
        initHands();
      } catch (err) {
        alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å: ' + err);
      }
    });

    function initHands() {
      const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`});

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
      });

      hands.onResults(onResults);

      const camera = new Camera(document.getElementById('video'), {
        onFrame: async () => await hands.send({image: document.getElementById('video')}),
        width: window.innerWidth,
        height: window.innerHeight
      });
      camera.start();
    }

    function onResults(results) {
      const canvas = document.getElementById('overlay');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (results.multiHandLandmarks) {
        for (let hand of results.multiHandLandmarks) {
          // –†–∏—Å—É–µ–º —Å–∫–µ–ª–µ—Ç —Ä—É–∫
          ctx.strokeStyle = '#00ff00';
          ctx.lineWidth = 5;
          ctx.beginPath();
          for (let i = 0; i < hand.length; i++) {
            const x = hand[i].x * canvas.width;
            const y = hand[i].y * canvas.height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // –ö—Ä—É–∂–∫–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö
          hand.forEach(lm => {
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(lm.x * canvas.width, lm.y * canvas.height, 8, 0, Math.PI*2);
            ctx.fill();
          });

          // Pinch detection: thumb (4) –∏ index (8)
          const thumb = hand[4];
          const index = hand[8];
          const dist = Math.hypot(thumb.x - index.x, thumb.y - index.y, thumb.z - index.z);

          if (dist < 0.05 && !pinchActive) {
            pinchActive = true;
            sad.currentTime = 0;
            sad.play().catch(() => console.log('–ó–≤—É–∫ –∑–∞–±–ª–æ—á–µ–Ω'));
            msg.style.display = 'block';
            setTimeout(() => {
              msg.style.display = 'none';
              pinchActive = false;
            }, 3000);
          }
        }
      }
    }
  </script>
</body>
</html>
